---
title: "Report on Billion Price Project"
output: 
  pdf_document:
    extra_dependencies: ["float"]
  #html_document
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
# Set graph size
#knitr::opts_chunk$set(echo = FALSE, out.width = "50%" )#fig.asp = 0.5, fig.width = 7, out.width = "90%" )

library(tidyverse)
library(modelsummary)
library(kableExtra)

# Import data and basic datamunging
bpp_orig <- read_csv( 'https://osf.io/yhbr5/download' )

bpp_orig <- bpp_orig %>% mutate( p_diff = price_online - price )

bpp <- bpp_orig %>% 
  filter( is.na(sale_online) ) %>%
  filter(!is.na(price)) %>%
  filter(!is.na(price_online)) %>% 
  filter(PRICETYPE == "Regular Price") %>% 
  filter( price < 1000 ) %>% 
  filter( p_diff < 500 & p_diff > -500 )

```

## Introduction

This is a report on *The Billion Price Project*.

HERE COMES THE MOTIVATION WHY THIS IS A MEANINGFUL PROJECT AND WHAT IS THE MAIN GOAL!

For more details on the project see: <http://www.thebillionpricesproject.com/>.

## Data

HERE COMES A DETAILLED EXPLANATION ABOUT WHERE THE DATA COMES FROM AND IF IT IS REPRESENTATIVE OR NOT.

Our main interest is whether online prices are lower or higher than simple retail store prices. We investigated the data on the collected prices and we have the following descriptive statistics on online, in-store prices and in their differences.

```{r, echo=FALSE}
P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
datasummary( (`Retail` = price ) + (`Online` = price_online ) + (`Price difference` = p_diff ) ~
             Mean + Median + SD + Min + Max + P05 + P95 , 
             data = bpp ,
             title = 'Descriptive statistics of prices',
             notes = 'Data are available from: https://osf.io/yhbr5/' ) %>% 
  kableExtra::kable_styling(latex_options = "hold_position")
```

The number of observations is `r sum(!is.na(bpp$price))` for all of our key variables.

DESCRIPTION OF THE SUMMARY STATS: WHAT CAN WE LEARN FROM THEM?

As the focus is the price difference, the next Figure shows the histogram for this variable.

```{r, echo=FALSE, warning=FALSE, fig.width=4, fig.height = 3, fig.align="center" }
ggplot( data = bpp ) +
  geom_density( aes( x = p_diff ) , fill = 'navyblue'  , bins = 30 ) +
  labs(x = "Price differences",
       y = "Relative Frequency" ) +
  xlim(-4,4) +
  theme_bw()
```

DESCRIPTION OF THE FIGURE. WHAT DOES IT TELS US?

(May change the order of descriptive stats and graph.)

## Testing Price Differences

```{r, echo = FALSE }

test_out <- t.test( bpp$p_diff , mu = 0 )

```

We test the hypothesis, whether the price difference is zero, therefore there is no difference between retail and online prices:

$$H_0:=\text{price online} - \text{price retail} = 0$$ $$H_A:=\text{price online} - \text{price retail} \neq 0$$ Running a two-sided t-test, we have the t-statistic as `r round( test_out$statistic , 2 )` and the p-value as `r round( test_out$p.value , 2 )`. The 95% confidence intervals are: `r round( test_out$conf.int[1] , 2 )` and `r round( test_out$conf.int[2] , 2 )`. Based on these results with 95% confidence we can reject the hypothesis that the two price would be the same in this particular sample.

## Robustness check / 'Heterogeneity analysis'

Task: calculate and report t-tests for each countries.

You should report: Country, mean of p_diff, se of the mean for p_diff, number of observations in each country, t-statistic, p-value.

Hint: use 'kable()' and to hold the table position you can define the following argument: 'position = "H"' . Take care of caption, number of digits you use and the name of variables you report! You may check how the output changes if you use 'booktabs = TRUE' input for kable!

```{r, echo = FALSE }
# When creating a factor, it will use the sorted values:
levels_fac <- sort( unique( bpp$COUNTRY ) )
# If want to have pretty variable nems when groupping, need to use 'labels' input!
# create a new variable for that:
labs <- c('Brazil','China','Germany','Japan','South Africa','USA')
# Note order must be the same as in `levels_fac`!
bpp$country <- factor( bpp$COUNTRY , labels = labs )
# Multiple hypothesis testing
testing <- bpp %>% 
  select( country , p_diff ) %>% 
  group_by( country ) %>% 
  summarise( mean_pdiff = mean( p_diff ) ,
             se_pdiff = 1/sqrt(n())*sd(p_diff),
             num_obs = n() )

# Testing in R is easy if one understands the theory!
testing <- mutate( testing , t_stat = mean_pdiff / se_pdiff )
testing <- mutate( testing , p_val = pt( -abs( t_stat ) , df = num_obs - 1 ) )
testing <- mutate( testing ,  p_val = round( p_val , digit = 4 ) )

# Report a tibble or any other dataframe/matrix variable
kable( testing , digits = 4, 
       caption = 'Online and retail price differences by countries and t-tests',
       col.names = c('Country','Mean','SE','Num.Obs','t-stat','p-val'),
       "latex", booktabs = TRUE,  position = "H")

```

Extra: In words, select those countries, where you can not reject the alternative that the prices are different. With the command '\textcolor{red}{this is red} you can highlight these countries!

Countries, where we can not reject the alternative with 95% confidence (or with 5% significance level), that the prices are different, hence retail and online prices might differ: \textcolor{red}{`r testing$country[ testing$p_val < 0.05]`}

## Conclusion

HERE COMES WHAT WE HAVE LEARNED AND WHAT WOULD STRENGHTEN AND WEAKEN OUR ANALYSIS.
